namespace = SSIOM


####Misc########
province_event = {
	id = SSIOM.30200
	desc = EVTDESC_SSI_30200

	picture = GFX_evt_aztec_arrival
	border = GFX_event_normal_frame_religion

	mean_time_to_happen = {
		months = 24
		modifier = {
			factor = 0.6
			offmap_aztecs = {
				has_policy = aztec_invaders
			}
		}
	}

	trigger = {
		aztecs_are_fine_trigger = yes
		NAND = {
			culture = nahuatl
			religion = aztec
		}
		owner = {
			top_liege = {
				is_offmap_governor = offmap_aztecs
				religion = aztec
				culture = nahuatl
			}
		}
		OR = {
			port = yes 
			any_neighbor_province = {
				AND = {
					religion = aztec
					culture = nahuatl
				}
			}
		}
	}

	option = {
		name = EVTOPTA_SSIOM_30200
		culture = nahuatl
		religion = aztec
	}

}

character_event = {
	id = SSIOM.30201
	desc = EVTDESC_SSI_30201

	picture = GFX_evt_aztec_arrival
	border = GFX_event_normal_frame_religion

	is_triggered_only = yes

	hide_window = yes

	trigger = {
		NOT = {
			had_global_flag = {
				flag = aztecs_recieved_tech_boost
				days = 36500 #Fire about once a century.
			}
		}
		is_offmap_governor = offmap_aztecs
		aztecs_are_fine_trigger = yes
	}

	immediate = {
		clr_global_flag = aztecs_recieved_tech_boost
		capital_scope = {
			aztec_set_high_tech_level_effect = yes
		}
		set_global_flag = aztecs_recieved_tech_boost
	}
}

character_event = {
	id = SSIOM.30202
	desc = EVTDESC_SSI_30202

	picture = GFX_evt_aztec_arrival
	border = GFX_event_normal_frame_religion

	is_triggered_only = yes

	hide_window = yes

	immediate = {
		FROM = {
			character_event = { id = SSIOM.30201 days = 2}
		}
	}
}



####Inheritance Event Triggered by on_offmap_governor_changed ####
# An offmap power changes its governor. Triggers for the new governor
# Root = New governor
# From = Old governor
# FromFrom = Offmap
character_event = { ###A veteran warrior from the Aztecs is sent over to rule the colony.
	id = SSIOM.30399
	desc = EVTDESC_SSI_30399

	picture = GFX_evt_aztec_arrival
	border = GFX_event_letter_frame_diplomacy

	hide_window = yes

	is_triggered_only = yes

	trigger = {
		is_offmap_governor = offmap_aztecs
	}

	immediate = {
	#option = { #Debug
		#name = debug_name
		remove_education_effect = yes
		random_list = {
			50 = {
				add_trait = skilled_tactician				
			}
			50 = {
				add_trait = brilliant_strategist
			}
		}
		change_diplomacy = -40 #Won't go negative, so will set all to zero to then set them myself.
		change_martial = -40
		change_stewardship = -40
		change_intrigue = -40
		change_learning = -40

		change_diplomacy = 2
		change_martial = 8
		change_stewardship = 6
		change_intrigue = 6
		change_learning = 4

		if = {
			limit = {
				has_trait = weak
			}
			remove_trait = weak
		}
		if = {
			limit = {
				has_trait = craven
			}
			remove_trait = craven
		}
		if = {
			limit = {
				FROMFROM = {
					OR = {
						culture = nahuatl
						culture = tlaxcalan
					}
				}
			}
			random = {
				chance = 5
				culture = tlaxcalan
				change_martial = 2
			}
		}
		random = {
			chance = 10
			add_trait = warrior_of_huitzilopochtli
		}
		random = {
			chance = 5
			add_trait = eagle_warrior
		}
		random_list = {
			10 = {
				give_nickname = nick_the_usurper
				change_martial = 2
				set_character_flag = debug_flag_1
			}
			10 = {
				give_nickname = nick_the_conqueror
				change_martial = 1
				change_stewardship = 1
				add_trait = aggressive_leader
				random = {
					chance = 10
					add_trait = scarred
				}
				set_character_flag = debug_flag_2
			}
			10 = {
				give_nickname = nick_the_victorious
				prestige = 1600
				add_trait = inspiring_leader
				random = {
					chance = 10
					add_trait = scarred
				}
				set_character_flag = debug_flag_3
			}
			10 = {
				give_nickname = nick_the_avenger #Avenging probably involves some sneakyness
				change_martial = 1
				change_intrigue = 4
				add_trait = schemer
				random = { #Was naughty
					chance = 5
					add_trait = paranoid
					add_trait = kinslayer
				}
				set_character_flag = debug_flag_4
			}
			10 = {
				give_nickname = nick_the_brave
				add_trait = inspiring_leader
				add_trait = brave
				random = {
					chance = 10
					add_trait = scarred
				}
				set_character_flag = debug_flag_5
			}
			10 = {
				give_nickname = nick_the_glorious
				prestige = 1800
				add_trait = inspiring_leader
				random = {
					chance = 10
					add_trait = scarred
				}
				set_character_flag = debug_flag_6
			}
			10 = {
				give_nickname = nick_the_culture
				set_character_flag = debug_flag_7
			}
			10 = {
				give_nickname = nick_the_destroyer
				add_trait = siege_leader #Of walls
				set_character_flag = debug_flag_8
			}
			10 = {
				give_nickname = nick_the_shadow
				change_martial = 1
				change_intrigue = 6
				add_trait = schemer
				add_trait = trickster
				set_character_flag = debug_flag_9
			}
			10 = {
				give_nickname = nick_the_ruthless
				change_martial = 2
				add_trait = cruel
				add_trait = arbitrary
				add_trait = aggressive_leader
				random = {
					chance = 20
					add_trait = scarred
				}
				set_character_flag = debug_flag_10
			}
		}
		if = {
			limit = {
				NOT = {
					has_any_lifestyle_trait = yes
				}
			}
			random_list = {
				10 = {
					add_trait = hedonist
					set_character_flag = debug_flag_1_2
				}
				10 = {
					add_trait = scholar
					set_character_flag = debug_flag_2_2
				}
				10 = {
					add_trait = impaler
					set_character_flag = debug_flag_3_2
				}
				10 = {
					add_trait = duelist
					set_character_flag = debug_flag_4_2
				}
				10 = {
					add_trait = hunter
					set_character_flag = debug_flag_5_2
				}
				10 = {
					add_trait = administrator
					set_character_flag = debug_flag_6_2
				}
				10 = {
					add_trait = architect
					set_character_flag = debug_flag_7_2
				}
				10 = {
					add_trait = strategist
					set_character_flag = debug_flag_8_2
				}
				10 = {
					add_trait = schemer
					set_character_flag = debug_flag_9_2
				}
				10 = {
					add_trait = gamer
					set_character_flag = debug_flag_10_2					
				}
			}
		}
		prestige = 1325
		piety = 1492
	}
}

## Explorer Aztecs - Doing nice stuff (hospitals and libraries and such.)
province_event = { #Aztecs build a hospital in a province.
	id = SSIOM.30400
	desc = EVTDESC_SSI_30400
	
	picture = GFX_evt_aztec_arrival
	border = GFX_event_letter_frame_diplomacy

	hide_window = yes

	mean_time_to_happen = {
		months = 160
	}

	trigger = {
		aztec_events_enabled_trigger = yes
		offmap_aztecs = {
			has_policy = aztec_explorers
		}
		aztecs_are_fine_trigger = yes
		NOT = {
			has_hospital = yes
		}
		owner = { #Be on goodish terms with the Huehuetlatoani
			is_within_diplo_range = offmap_aztecs
			OR = {
				has_offmap_currency = { offmap = offmap_aztecs value > 50 }
				AND = {
					has_offmap_currency = { offmap = offmap_aztecs value > 25 }
				}
				top_liege = {
					has_offmap_currency = { offmap = offmap_aztecs value > 200 }
				}
			}
		}
	}

	immediate = {
		save_event_target_as = hospital_county
		owner = {
			save_event_target_as = hospital_county_owner
			character_event = { id = SSIOM.30403 }
		}
	}
}

character_event = {
	id = SSIOM.30403
	desc = EVTDESC_SSI_30403
	
	border = GFX_event_letter_frame_diplomacy

	hide_window = yes

	is_triggered_only = yes

	immediate = {
		offmap_aztecs = {
			governor = {
				character_event = { id = SSIOM.30401 }
			}
		}
	}
}

character_event = {
	id = SSIOM.30401
	desc = EVTDESC_SSI_30401
	
	picture = GFX_evt_aztec_arrival
	border = GFX_event_letter_frame_diplomacy

	hide_window = yes

	is_triggered_only = yes

	immediate = {
		FROM = {
			letter_event = { id = SSIOM.30402 }
		}
	}
}

letter_event = {
	id = SSIOM.30402
	desc = EVTDESC_SSI_30402
	
	picture = GFX_evt_aztec_arrival
	border = GFX_event_letter_frame_diplomacy

	#hide_window = yes

	is_triggered_only = yes

	option = { #Sure
		name = EVTOPTA_SSIOM_30402
		event_target:hospital_county_owner = {
			prestige = -100
			piety = 100
			add_offmap_currency = {
				offmap = offmap_aztecs
				value =  100
			}
		}
		create_hospital = event_target:hospital_county
	}

	option = { #Nah
		name = EVTOPTB_SSIOM_30402
		event_target:hospital_county_owner = {
			prestige = 100
			piety = -100
			add_offmap_currency = {
				offmap = offmap_aztecs
				value =  -100
			}
		}
	}
}



### Trader Aztecs - Trade deals and trade posts &c.



### Invader Aztecs - Doing bad stuff (war, forts, assassinations &c.)
# Happens once a year during a random monthly update. Triggers for the governor (once for each offmap governor, if there's more than one)
# Root = Governor
# From = Offmap
character_event = {
    id = SSIOM.10100
    has_dlc = "Sunset Invasion"
    is_triggered_only = yes

    hide_window = yes
    
    trigger = {
		aztec_events_enabled_trigger = yes
		FROM = { is_offmap_tag = offmap_aztecs }
    	war = no
		NOT = { has_offmap_tmp_flag = launching_invasion_of_the_east }
		aztecs_are_fine_trigger = yes
		#NOR = {
		#	has_game_rule = {
		#		name = aztec_invasions
		#		value = none
		#	}
		#	has_game_rule = {
		#		name = aztec_invasions
		#		value = adventurers_only
		#	}
		#}
    }

    immediate = {
		set_offmap_tmp_flag = launching_invasion_of_the_east
		
		save_event_target_as = the_huehuecalpixqueh
	
    	if = { #If the WP currently holds land on map
			limit = { event_target:the_huehuecalpixqueh = { is_landed = yes } }
			set_offmap_tmp_flag = colony_is_on_map
		}
		if = { #If the WP is NOT on map
			limit = { event_target:the_huehuecalpixqueh = { is_landed = no } }
			set_offmap_tmp_flag = colony_is_not_on_map
		}

		random_list = {
			100 = { #Tributary Invasion [Medium]...
    			trigger = {
    				NOT = { has_offmap_tmp_flag = tributary_invasion_fired }
    				OR = {
    					AND = {
	    					NOT = { has_policy = aztec_invaders }
		    				any_independent_ruler = {
		    					valid_offmap_aztecs_target_location = yes
								valid_offmap_aztecs_target = yes
								NOT = { num_of_count_titles_in_realm = 20 }
								num_of_count_titles_in_realm > 0
				    		}
    					}
    					AND = {
    						has_policy = aztec_invaders
    						any_independent_ruler = {
								valid_offmap_aztecs_target_location = yes
				    			num_of_count_titles_in_realm = 15
								valid_offmap_aztecs_target = yes
				    		}
    					}
    				}
    			}   			
    			modifier = {
    				factor = 1.5
    				has_offmap_tmp_flag = colony_is_not_on_map
    			}
    			#modifier = {
    			#	factor = 1.5
    			#	OR = {
	    		#		aztecs_are_stable_expansionist_trigger = yes
    			#		aztecs_are_golden_age_open_trigger = yes
    			#	}
    			#}
    			modifier = {
    				factor = 10 #strongly encouraged if China does not have some tributaries already (and not expansionist - if so, they'll opt for taking land instead)
    				OR = {
    					AND = {
    						aztecs_are_stable_open_trigger = yes
		    				NOT = {
		    					any_playable_ruler = {
		    						count = 4
									is_tributary = {
										suzerain = ROOT
									}
		    					}
		    				}
    					}
    					AND = {
    						aztecs_are_golden_age_open_trigger = yes
		    				NOT = {
		    					any_playable_ruler = {
		    						count = 9
									is_tributary = {
										suzerain = ROOT
									}
		    					}
		    				}
    					}
    				}
    			}
    			modifier = {
    				factor = 2
    				has_status = aztec_golden_age
    			}

    			random_list = { # Selects big or small target...

    				10 = { #Going after small tributary...!
    					trigger = {
							OR = {
								NOT = { has_policy = aztec_invaders }
								AND = {
									has_policy = aztec_invaders
									NOT = {
										any_independent_ruler = {
											valid_offmap_aztecs_target_location = yes
											num_of_count_titles_in_realm = 15
											valid_offmap_aztecs_target = yes
										}
									}
								}
							}
		    			}
						
						#1. Selects an appropriate target... (worst case), prefer not attacking someone who supplies horses
		    			random_independent_ruler = {
		    				limit = {
								valid_offmap_aztecs_target_location = yes
								valid_offmap_aztecs_target = yes
								NOT = { num_of_count_titles_in_realm = 20 }
								num_of_count_titles_in_realm > 0
				    		}
				    		save_event_target_as = aztec_invasion_target
		    			}
						
						#3. Selects an appropriate target... (worst case), pick someone who raids china if possible
		    			random_independent_ruler = {
		    				limit = {
								valid_offmap_aztecs_target_location = yes
								valid_offmap_aztecs_target = yes
								has_character_modifier = aztec_raid_active
				    		}
				    		save_event_target_as = aztec_invasion_target
		    			}
						
						#4. Finds someone within the appropriate geographical sphere... (better), prefer not attacking someone who supplies horses
		    			random_independent_ruler = {
				    		limit = {
				    			valid_offmap_aztecs_target = yes
								valid_offmap_aztecs_target_location = yes
								NOT = { num_of_count_titles_in_realm = 20 }
								num_of_count_titles_in_realm > 0
				    		}
				    		save_event_target_as = aztec_invasion_target
						}
						
						#6. Finds someone within the appropriate geographical sphere... (better), pick someone who raids china if possible
		    			random_independent_ruler = {
				    		limit = {
				    			valid_offmap_aztecs_target = yes
								valid_offmap_aztecs_target_location = yes
								NOT = { num_of_count_titles_in_realm = 20 }
								num_of_count_titles_in_realm > 0
								has_character_modifier = aztec_raid_active
				    		}
				    		save_event_target_as = aztec_invasion_target
						}
						
						#7. Finds someone liked by the emperor... (best), prefer not attacking someone who supplies horses
		    			random_independent_ruler = {
				    		limit = {
				    			valid_offmap_aztecs_target = yes
								valid_offmap_aztecs_target_location = yes
								NOT = { num_of_count_titles_in_realm = 20 }
								num_of_count_titles_in_realm > 0
								liked_by_offmap = { type = offmap_aztecs }
								NOT = { disliked_by_offmap = { type = offmap_aztecs } }
				    		}
				    		save_event_target_as = aztec_invasion_target
						}
						
						#9. Finds someone liked by the emperor... (best), pick someone who raids china if possible
		    			random_independent_ruler = {
				    		limit = {
				    			valid_offmap_aztecs_target = yes
								valid_offmap_aztecs_target_location = yes
								NOT = { num_of_count_titles_in_realm = 20 }
								num_of_count_titles_in_realm > 0
								liked_by_offmap = { type = offmap_aztecs }
								NOT = { disliked_by_offmap = { type = offmap_aztecs } }
								has_character_modifier = aztec_raid_active
				    		}
				    		save_event_target_as = aztec_invasion_target
						}
						
						#10. Selects an appropriate target... (worst case for border gore), prefer not attacking someone who supplies horses #Ewww
		    			random_independent_ruler = {
		    				limit = {
								valid_offmap_aztecs_target_location_tributary_chain = yes
								valid_offmap_aztecs_target = yes
								NOT = { num_of_count_titles_in_realm = 20 }
								num_of_count_titles_in_realm > 0
				    		}
				    		save_event_target_as = aztec_invasion_target
		    			}
						
						#12. Selects an appropriate target... (worst case for border gore), pick someone who raids china if possible
		    			random_independent_ruler = {
		    				limit = {
								valid_offmap_aztecs_target_location_tributary_chain = yes
								valid_offmap_aztecs_target = yes
								has_character_modifier = aztec_raid_active
				    		}
				    		save_event_target_as = aztec_invasion_target
		    			}
						
						#13. Finds someone within the appropriate geographical sphere... (better, also good for border gore), prefer not attacking someone who supplies horses
		    			random_independent_ruler = {
				    		limit = {
				    			valid_offmap_aztecs_target = yes
								valid_offmap_aztecs_target_location_tributary_chain = yes
								NOT = { num_of_count_titles_in_realm = 20 }
								num_of_count_titles_in_realm > 0
				    		}
				    		save_event_target_as = aztec_invasion_target
						}
						
						#15. Finds someone within the appropriate geographical sphere... (better, also good for border gore), pick someone who raids china if possible
		    			random_independent_ruler = {
				    		limit = {
				    			valid_offmap_aztecs_target = yes
								valid_offmap_aztecs_target_location_tributary_chain = yes
								NOT = { num_of_count_titles_in_realm = 20 }
								num_of_count_titles_in_realm > 0
								has_character_modifier = aztec_raid_active
				    		}
				    		save_event_target_as = aztec_invasion_target
						}
						
						#16. Finds someone liked by the emperor... (best, also good for border gore), prefer not attacking someone who supplies horses
		    			random_independent_ruler = {
				    		limit = {
				    			valid_offmap_aztecs_target = yes
								valid_offmap_aztecs_target_location_tributary_chain = yes
								NOT = { num_of_count_titles_in_realm = 20 }
								num_of_count_titles_in_realm > 0
								liked_by_offmap = { type = offmap_aztecs }
								NOT = { disliked_by_offmap = { type = offmap_aztecs } }
				    		}
				    		save_event_target_as = aztec_invasion_target
						}
						
						#18. Finds someone liked by the emperor... (best, also good for border gore), pick someone who raids china if possible
		    			random_independent_ruler = {
				    		limit = {
				    			valid_offmap_aztecs_target = yes
								valid_offmap_aztecs_target_location_tributary_chain = yes
								NOT = { num_of_count_titles_in_realm = 20 }
								num_of_count_titles_in_realm > 0
								liked_by_offmap = { type = offmap_aztecs }
								NOT = { disliked_by_offmap = { type = offmap_aztecs } }
								has_character_modifier = aztec_raid_active
				    		}
				    		save_event_target_as = aztec_invasion_target
						}
    				}

    				10 = {  # Going after bigger tributary...! (only if expansionist)
    					trigger = {
				    		has_policy = aztec_invaders
				    		any_independent_ruler = {
								valid_offmap_aztecs_target_location = yes
				    			num_of_count_titles_in_realm = 15
								valid_offmap_aztecs_target = yes
				    		}
		    			}
		    			modifier = {
		    				factor = 10
		    				aztecs_are_golden_age_expansionist_trigger = yes
		    			}
						
						#1. Finds an appropriate target... (worst case), prefer not attacking someone who supplies horses
		    			random_independent_ruler = {
		    				limit = {
								valid_offmap_aztecs_target_location = yes
				    			num_of_count_titles_in_realm = 15
								valid_offmap_aztecs_target = yes
				    		}
				    		save_event_target_as = aztec_invasion_target
		    			}
						
    					#2. Finds an appropriate target... (worst case)
		    			random_independent_ruler = {
		    				limit = {
								valid_offmap_aztecs_target_location = yes
				    			num_of_count_titles_in_realm = 15
								valid_offmap_aztecs_target = yes
								NOT = { has_character_modifier = aztecs_supply_horses }
				    		}
				    		save_event_target_as = aztec_invasion_target
		    			}
						
						#3. Finds an appropriate target... (worst case), pick someone who raids china if possible
		    			random_independent_ruler = {
		    				limit = {
								valid_offmap_aztecs_target_location = yes
				    			num_of_count_titles_in_realm = 15
								valid_offmap_aztecs_target = yes
								NOT = { has_character_modifier = aztecs_supply_horses }
								has_character_modifier = aztec_raid_active
				    		}
				    		save_event_target_as = aztec_invasion_target
		    			}
						
						#4. Finds someone with more counties... (better), prefer not attacking someone who supplies horses
		    			random_independent_ruler = {
				    		limit = {
								valid_offmap_aztecs_target_location = yes
				    			num_of_count_titles_in_realm = 20
								valid_offmap_aztecs_target = yes
				    		}
				    		save_event_target_as = aztec_invasion_target
						}

		    			#5. Finds someone with more counties... (better)
		    			random_independent_ruler = {
				    		limit = {
								valid_offmap_aztecs_target_location = yes
				    			num_of_count_titles_in_realm = 20
								valid_offmap_aztecs_target = yes
								NOT = { has_character_modifier = aztecs_supply_horses }
				    		}
				    		save_event_target_as = aztec_invasion_target
						}
						
						#6. Finds someone with more counties... (better), pick someone who raids china if possible
		    			random_independent_ruler = {
				    		limit = {
								valid_offmap_aztecs_target_location = yes
				    			num_of_count_titles_in_realm = 20
								valid_offmap_aztecs_target = yes
								NOT = { has_character_modifier = aztecs_supply_horses }
								has_character_modifier = aztec_raid_active
				    		}
				    		save_event_target_as = aztec_invasion_target
						}
						
						#7. Finds someone who is liked by the Emperor (best), prefer not attacking someone who supplies horses
						if = { limit = { has_policy = aztec_invaders }
			    			random_independent_ruler = {
					    		limit = {
					    			valid_offmap_aztecs_target = yes
									valid_offmap_aztecs_target_location = yes
									num_of_count_titles_in_realm = 20
									liked_by_offmap = { type = offmap_aztecs }
									NOT = { disliked_by_offmap = { type = offmap_aztecs } }
					    		}
					    		save_event_target_as = aztec_invasion_target
							}
						}
						
						#8. Finds someone who is liked by the Emperor (best)
						if = { limit = { has_policy = aztec_invaders }
			    			random_independent_ruler = {
					    		limit = {
					    			valid_offmap_aztecs_target = yes
									valid_offmap_aztecs_target_location = yes
									num_of_count_titles_in_realm = 20
									liked_by_offmap = { type = offmap_aztecs }
									NOT = { disliked_by_offmap = { type = offmap_aztecs } }
									NOT = { has_character_modifier = aztecs_supply_horses }
					    		}
					    		save_event_target_as = aztec_invasion_target
							}
						}
						
						#9. Finds someone who is liked by the Emperor (best), pick someone who raids china if possible
						if = { limit = { has_policy = aztec_invaders }
			    			random_independent_ruler = {
					    		limit = {
					    			valid_offmap_aztecs_target = yes
									valid_offmap_aztecs_target_location = yes
									num_of_count_titles_in_realm = 20
									liked_by_offmap = { type = offmap_aztecs }
									NOT = { disliked_by_offmap = { type = offmap_aztecs } }
									NOT = { has_character_modifier = aztecs_supply_horses }
									has_character_modifier = aztec_raid_active
					    		}
					    		save_event_target_as = aztec_invasion_target
							}
						}
						
						#10. Finds an appropriate target neighboring them... (worst case for border gore), prefer not attacking someone who supplies horses
		    			random_independent_ruler = {
		    				limit = {
								valid_offmap_aztecs_target_location_tributary_chain = yes
				    			num_of_count_titles_in_realm = 15
								valid_offmap_aztecs_target = yes
				    		}
				    		save_event_target_as = aztec_invasion_target
		    			}
						
						#11. Finds an appropriate target neighboring them... (worst case for border gore)
		    			random_independent_ruler = {
		    				limit = {
								valid_offmap_aztecs_target_location_tributary_chain = yes
				    			num_of_count_titles_in_realm = 15
								valid_offmap_aztecs_target = yes
								NOT = { has_character_modifier = aztecs_supply_horses }
				    		}
				    		save_event_target_as = aztec_invasion_target
		    			}
						
						#12. Finds an appropriate target neighboring them... (worst case for border gore), pick someone who raids china if possible
		    			random_independent_ruler = {
		    				limit = {
								valid_offmap_aztecs_target_location_tributary_chain = yes
				    			num_of_count_titles_in_realm = 15
								valid_offmap_aztecs_target = yes
								NOT = { has_character_modifier = aztecs_supply_horses }
								has_character_modifier = aztec_raid_active
				    		}
				    		save_event_target_as = aztec_invasion_target
		    			}
						
						#13. Finds someone with more counties that also neighbours them... (better, also good for border gore), prefer not attacking someone who supplies horses
		    			random_independent_ruler = {
				    		limit = {
								valid_offmap_aztecs_target_location_tributary_chain = yes
				    			num_of_count_titles_in_realm = 20
								valid_offmap_aztecs_target = yes
				    		}
				    		save_event_target_as = aztec_invasion_target
						}
						
						#14. Finds someone with more counties that also neighbours them... (better, also good for border gore)
		    			random_independent_ruler = {
				    		limit = {
								valid_offmap_aztecs_target_location_tributary_chain = yes
				    			num_of_count_titles_in_realm = 20
								valid_offmap_aztecs_target = yes
								NOT = { has_character_modifier = aztecs_supply_horses }
				    		}
				    		save_event_target_as = aztec_invasion_target
						}
						
						#15. Finds someone with more counties that also neighbours them... (better, also good for border gore), pick someone who raids china if possible
		    			random_independent_ruler = {
				    		limit = {
								valid_offmap_aztecs_target_location_tributary_chain = yes
				    			num_of_count_titles_in_realm = 20
								valid_offmap_aztecs_target = yes
								NOT = { has_character_modifier = aztecs_supply_horses }
								has_character_modifier = aztec_raid_active
				    		}
				    		save_event_target_as = aztec_invasion_target
						}
						
						#16. Finds someone who is liked by the Emperor that also neighbours them (best, also good for border gore), prefer not attacking someone who supplies horses
						if = { limit = { has_policy = aztec_invaders }
			    			random_independent_ruler = {
					    		limit = {
					    			valid_offmap_aztecs_target = yes
									valid_offmap_aztecs_target_location_tributary_chain = yes
									num_of_count_titles_in_realm = 20
									liked_by_offmap = { type = offmap_aztecs }
									NOT = { disliked_by_offmap = { type = offmap_aztecs } }
					    		}
					    		save_event_target_as = aztec_invasion_target
							}
						}
						
						#17. Finds someone who is liked by the Emperor that also neighbours them (best, also good for border gore)
						if = { limit = { has_policy = aztec_invaders }
			    			random_independent_ruler = {
					    		limit = {
					    			valid_offmap_aztecs_target = yes
									valid_offmap_aztecs_target_location_tributary_chain = yes
									num_of_count_titles_in_realm = 20
									liked_by_offmap = { type = offmap_aztecs }
									NOT = { disliked_by_offmap = { type = offmap_aztecs } }
									NOT = { has_character_modifier = aztecs_supply_horses }
					    		}
					    		save_event_target_as = aztec_invasion_target
							}
						}
						
						#18. Finds someone who is liked by the Emperor that also neighbours them (best, also good for border gore), pick someone who raids china if possible
						if = { limit = { has_policy = aztec_invaders }
			    			random_independent_ruler = {
					    		limit = {
					    			valid_offmap_aztecs_target = yes
									valid_offmap_aztecs_target_location_tributary_chain = yes
									num_of_count_titles_in_realm = 20
									liked_by_offmap = { type = offmap_aztecs }
									NOT = { disliked_by_offmap = { type = offmap_aztecs } }
									NOT = { has_character_modifier = aztecs_supply_horses }
									has_character_modifier = aztec_raid_active
					    		}
					    		save_event_target_as = aztec_invasion_target
							}
						}
    				}
    			}

				event_target:aztec_invasion_target = { character_event = { id = SSIOM.10130 } } #Send a demand - "Become tributary or prepare to be defeated"...
				#change_variable = { which = global_tributary_invasions_launched value = 1 } #for logging purposes
			}

			100 = { # Major Invasion [Major (or Medium, OR small, as it turns out)]...
				trigger = {
    				NOT = { has_offmap_tmp_flag = major_invasion_fired }
					
					#NOT = {
					#	has_game_rule = {
					#		name = chinese_invasions
					#		value = no_major_invasions
					#	}
					#}
    				
    				OR = {
    					#Can grab Jiuquan (dunuhang, etc)
    					AND = {
	    					NOT = { completely_controls = d_beja }
	    					d_jiuquan = {
	    						any_direct_de_jure_vassal_title = {
		    						holder_scope = {
										top_liege = {
											valid_offmap_aztecs_target = yes
										}
									}
	    						}
	    					}
    					}
    					
    					#Can do a MEDIUM land grab
    					AND = {
    						has_policy = aztec_invaders
							OR = {
								AND = { # must either be an eligble realm around within the target area...
									has_offmap_tmp_flag = colony_is_on_map
				    				any_independent_ruler = {
										valid_offmap_aztecs_target_location = yes
										is_nomadic = no # Don't subjugate nomads
										num_of_count_titles_in_realm = 15
										NOT = { num_of_count_titles_in_realm = 30 }
						    			valid_offmap_aztecs_target = yes
									}	
								}
								AND = { # or, if WP is unlanded, an eligble realm by the eastern border of the map...
									has_offmap_tmp_flag = colony_is_not_on_map
				    				any_independent_ruler = {
										capital_scope = { port = yes }
										is_nomadic = no # Don't subjugate nomads
										num_of_count_titles_in_realm = 10
										NOT = { num_of_count_titles_in_realm = 40 }
						    			valid_offmap_aztecs_target = yes
									}	
								}
							}
    					}

    					#Can do a BIG land grab
    					AND = {
    						has_policy = aztec_invaders
							OR = {
								AND = { # must either be an eligble realm around within the target area...
									has_offmap_tmp_flag = colony_is_on_map
			    					any_independent_ruler = {
				    					valid_offmap_aztecs_target_location = yes #within the right area...
										is_nomadic = no # Don't subjugate nomads
										num_of_count_titles_in_realm = 20
						    			valid_offmap_aztecs_target = yes
									}
								}
								AND = { # or, if WP is unlanded, an eligble realm by the eastern border of the map...
									has_offmap_tmp_flag = colony_is_not_on_map
				    				any_independent_ruler = {
										capital_scope = { region = custom_eastern_edge_of_map }
										is_nomadic = no # Don't subjugate nomads
										num_of_count_titles_in_realm = 20
						    			valid_offmap_aztecs_target = yes
									}	
								}
							}
    					}

    					#Can trigger the failsafe (potentially SMALL land grab)
    					AND = {
    						has_offmap_tmp_flag = colony_is_on_map
		    				any_neighbor_independent_ruler = {
								valid_offmap_aztecs_target_location = yes
				    			valid_offmap_aztecs_target = yes
								higher_real_tier_than = BARON
								is_nomadic = no # Don't subjugate nomads
							}
    					}
    				}
    			}

				modifier = {
					factor = 1.5
					has_status = aztec_golden_age
				}
				modifier = {
					factor = 3
					has_policy = aztec_invaders
				}
				modifier = {
					factor = 4
					aztecs_are_golden_age_expansionist_trigger = yes
				}
				modifier = {
					factor = 2 #More likely to happen if China is NOT on the map ... (they want land!)
					has_offmap_tmp_flag = colony_is_not_on_map 
					OR = {
						has_status = aztec_golden_age
						has_policy = aztec_invaders
					}
				}

				random_list = {
					100 = { # Go for Jiuquan (Grab Dunhuang, Anxi, etc - regardless of expansionist or not, on map or not) 
						trigger = {
							NOT = { completely_controls = d_beja }
	    					d_jiuquan = {
	    						any_direct_de_jure_vassal_title = {
		    						holder_scope = {
										top_liege = {
											valid_offmap_aztecs_target = yes
										}
									}
	    						}
	    					}
						}

						#The WP will try to grab whatever they can within Jiuquan...
						d_beja = {
							#add_claim = ROOT #No claim on the duchy title, as then they can grab more land than intended - they can usurp it afterwards instead					
							any_direct_de_jure_vassal_title = {
								add_claim = ROOT
							}
							random_direct_de_jure_vassal_title = {
								limit = {
									holder_scope = {
										top_liege = {
											valid_offmap_aztecs_target = yes
										}
									}
								}
								holder_scope = {
									top_liege = {
										save_event_target_as = aztec_invasion_target
									}
								}
							}
						}	    				
						set_offmap_tmp_flag = should_claim_all_titles_war # Makes sure they will go after Jiuquan counties...
						#change_variable = { which = global_major_invasions_launched value = 1 } # For logging purposes
					}

					50 = { # Go for something medium sized (MEDIUM land grab - if expansionist)
						trigger = {
							has_policy = aztec_invaders
							OR = {
								AND = { # must either be an eligble realm around within the target area...
									has_offmap_tmp_flag = colony_is_on_map
				    				any_independent_ruler = {
										valid_offmap_aztecs_target_location = yes
										is_nomadic = no # Don't subjugate nomads
										num_of_count_titles_in_realm = 15
										NOT = { num_of_count_titles_in_realm = 30 }
						    			valid_offmap_aztecs_target = yes
									}	
								}
								AND = { # or, if WP is unlanded, an eligble realm by the eastern border of the map...
									has_offmap_tmp_flag = colony_is_not_on_map
				    				any_independent_ruler = {
										capital_scope = { port = yes }
										is_nomadic = no # Don't subjugate nomads
										num_of_count_titles_in_realm = 10
										NOT = { num_of_count_titles_in_realm = 40 }
						    			valid_offmap_aztecs_target = yes
									}	
								}
							}
						}

						# If WP is landed
						if = { limit = { has_offmap_tmp_flag = colony_is_on_map }
							random_independent_ruler = {
					    		limit = {
					    			valid_offmap_aztecs_target_location = yes #within the right area...
									is_nomadic = no # Don't subjugate nomads
									num_of_count_titles_in_realm = 15
									NOT = { num_of_count_titles_in_realm = 30 }
					    			valid_offmap_aztecs_target = yes
					    		}
					    		save_event_target_as = aztec_invasion_target
							}
						}

						#However, if someone nearby also fits the bill, go for that instead (overwrites saved target)
						if = { limit = { has_offmap_tmp_flag = colony_is_on_map } 
							random_neighbor_independent_ruler = {
					    		limit = {
					    			valid_offmap_aztecs_target_location = yes #within the right area...
									is_nomadic = no # Don't subjugate nomads
									num_of_count_titles_in_realm = 15
									NOT = { num_of_count_titles_in_realm = 30 }
					    			valid_offmap_aztecs_target = yes
					    		}
					    		save_event_target_as = aztec_invasion_target
							}
						}

						#Exception: if WP is unlanded (then go Eastern Edge of map)
						if = { limit = { has_offmap_tmp_flag = colony_is_not_on_map }
							random_independent_ruler = {
					    		limit = {
					    			capital_scope = { region = custom_eastern_edge_of_map }
									is_nomadic = no # Don't subjugate nomads
									num_of_count_titles_in_realm = 10
									NOT = { num_of_count_titles_in_realm = 40 }
					    			valid_offmap_aztecs_target = yes
					    		}
					    		save_event_target_as = aztec_invasion_target
							}
						}
						set_offmap_tmp_flag = start_submission_war
						#change_variable = { which = global_major_invasions_launched value = 1 } # For logging purposes
					}

					10 = { # Go for something big (BIG land grab - if expansionist)
						trigger = {
	    					has_policy = aztec_invaders
							OR = {
								AND = { # must either be an eligble realm around within the target area...
									has_offmap_tmp_flag = colony_is_on_map
			    					any_independent_ruler = {
				    					valid_offmap_aztecs_target_location = yes #within the right area...
										is_nomadic = no # Don't subjugate nomads
										num_of_count_titles_in_realm = 20
						    			valid_offmap_aztecs_target = yes
									}
								}
								AND = { # or, if WP is unlanded, an eligble realm by the eastern border of the map...
									has_offmap_tmp_flag = colony_is_not_on_map
				    				any_independent_ruler = {
										capital_scope = { region = custom_eastern_edge_of_map }
										is_nomadic = no # Don't subjugate nomads
										num_of_count_titles_in_realm = 20
						    			valid_offmap_aztecs_target = yes
									}	
								}
							}
		    			}
		    			modifier = {
							factor = 2
							has_status = aztec_golden_age
						}

						# If WP is landed, find target (good)
						if = { limit = { has_offmap_tmp_flag = colony_is_on_map }
							random_independent_ruler = {
					    		limit = {
					    			valid_offmap_aztecs_target_location = yes #within the right area...
									is_nomadic = no # Don't subjugate nomads
									num_of_count_titles_in_realm = 20
					    			valid_offmap_aztecs_target = yes
					    		}
					    		save_event_target_as = aztec_invasion_target
							}
						}

						# Although, if someone is available that the Emperor also DISLIKES... (better)
						if = { limit = { has_offmap_tmp_flag = colony_is_on_map }
							random_independent_ruler = {
					    		limit = {
					    			valid_offmap_aztecs_target_location = yes #within the right area...
									is_nomadic = no # Don't subjugate nomads
									num_of_count_titles_in_realm = 20
					    			valid_offmap_aztecs_target = yes
					    			disliked_by_offmap = { type = offmap_aztecs }
									NOT = { liked_by_offmap = { type = offmap_aztecs } }
					    		}
					    		save_event_target_as = aztec_invasion_target
							}
						}

						#However, if someone nearby also fits the bill, go for that instead... (even better)
						if = { limit = { has_offmap_tmp_flag = colony_is_on_map } 
							random_neighbor_independent_ruler = {
					    		limit = {
									is_nomadic = no # Don't subjugate nomads
									num_of_count_titles_in_realm = 20
					    			valid_offmap_aztecs_target = yes
					    		}
					    		save_event_target_as = aztec_invasion_target
							}
						}

						#However, if someone nearby fits, and the Emperor also DISLIKES them, jackpot... (best)
						if = { limit = { has_offmap_tmp_flag = colony_is_on_map } 
							random_neighbor_independent_ruler = {
					    		limit = {
									is_nomadic = no # Don't subjugate nomads
									num_of_count_titles_in_realm = 20
					    			valid_offmap_aztecs_target = yes
									disliked_by_offmap = { type = offmap_aztecs }
									NOT = { liked_by_offmap = { type = offmap_aztecs } }
					    		}
					    		save_event_target_as = aztec_invasion_target
							}
						}

						#Exception: if WP is unlanded (then go Eastern Edge of map)
						if = { limit = { has_offmap_tmp_flag = colony_is_not_on_map }
							random_independent_ruler = {
					    		limit = {
					    			capital_scope = { region = custom_eastern_edge_of_map }
									is_nomadic = no # Don't subjugate nomads
									num_of_count_titles_in_realm = 20
					    			valid_offmap_aztecs_target = yes
					    		}
					    		save_event_target_as = aztec_invasion_target
							}
						}
						set_offmap_tmp_flag = start_submission_war
						#change_variable = { which = global_major_invasions_launched value = 1 } # For logging purposes
					}

					100 = { # FAILSAFE: Go for something nearby and possibly small sized (SMALL (?) land grab - only if on map and with appropriate NEIGHBORS (to prevent bordergore))
						trigger = {
							# there must be an eligble neighbor realm around, within the target area...
							has_offmap_tmp_flag = colony_is_on_map
		    				any_neighbor_independent_ruler = {
								valid_offmap_aztecs_target_location = yes
				    			valid_offmap_aztecs_target = yes
								is_nomadic = no # Don't subjugate nomads
							}
						}

						#Picks any random neighboring ruler...
						random_neighbor_independent_ruler = {
				    		limit = {
				    			valid_offmap_aztecs_target_location = yes #within the right area...
								is_nomadic = no # Don't subjugate nomads
				    			valid_offmap_aztecs_target = yes
				    		}
				    		save_event_target_as = aztec_invasion_target
						}
						# Try to find a small target
						random_neighbor_independent_ruler = {
				    		limit = {
				    			valid_offmap_aztecs_target_location = yes #within the right area...
								NOT = { num_of_count_titles_in_realm = 20 }
								is_nomadic = no # Don't subjugate nomads
				    			valid_offmap_aztecs_target = yes
				    		}
				    		save_event_target_as = aztec_invasion_target
						}
						# Try to find a smaller target
						random_neighbor_independent_ruler = {
				    		limit = {
				    			valid_offmap_aztecs_target_location = yes #within the right area...
								NOT = { num_of_count_titles_in_realm = 10 }
								is_nomadic = no # Don't subjugate nomads
				    			valid_offmap_aztecs_target = yes
				    		}
				    		save_event_target_as = aztec_invasion_target
						}
						# Best case - Try to find an even smaller target
						random_neighbor_independent_ruler = {
				    		limit = {
				    			valid_offmap_aztecs_target_location = yes #within the right area...
								NOT = { num_of_count_titles_in_realm = 5 }
								is_nomadic = no # Don't subjugate nomads
				    			valid_offmap_aztecs_target = yes
				    		}
				    		save_event_target_as = aztec_invasion_target
						}

						set_offmap_tmp_flag = start_submission_war

						if = { 
							limit = { 
								event_target:aztec_invasion_target = { 
									NOT = { num_of_count_titles_in_realm = 20 }
								} 
							} #tracks whether this should actually count as a "major" invasion or not
							set_offmap_tmp_flag = attacked_small_neighbor
						}
						else_if = {
							limit = {
								NOT = { has_policy = aztec_invaders }
							}
							#Target to big for non-expansionist Aztecs, Abort!
							
							### Logging
							log = "-------------------------------------"
							log = "Aztec Logging:"
							log = "Non-expansionist Aztec didn't find a suitable submission target"
							log = "No invasions happened this year - clearing all flags. Better luck next year!"
							log = "Current status: [From.Offmap.GetStatus]. Current policy: [From.Offmap.GetPolicy]."
							log = "-------------------------------------"
							####

							offmap_aztecs = {
								clr_offmap_tmp_flag = colony_is_on_map
								clr_offmap_tmp_flag = colony_is_not_on_map
								clr_offmap_tmp_flag = launching_invasion_of_the_west
								clr_offmap_tmp_flag = tributary_invasion_fired
								clr_offmap_tmp_flag = major_invasion_fired
								clr_offmap_tmp_flag = sent_major_invasion_cleanup
								clr_offmap_tmp_flag = pretender_chinese_empire_exists
								clr_offmap_tmp_flag = start_submission_war
							}
							break = yes # Careless, I know...
						}
						else = {
							#change_variable = { which = global_major_invasions_launched value = 1 } # For logging purposes
						}
					}
				}

				character_event = { id = SSIOM.10103 } # Checks for which type of war to be declared, declares war on aztec_invasion_target + send news event to players...
				#change_variable = { which = global_major_invasions_launched value = 1 } # For logging purposes
			}

			100 = {
				#Nothing happens
				modifier = {
					factor = 0
					offmap_aztecs = { has_policy = aztec_invaders }
				}
				### Logging
				log = "-------------------------------------"
				log = "Aztec Logging:"
				log = "No invasions happened this year - clearing all flags. Better luck next year!"
				log = "Current status: [From.Offmap.GetStatus]. Current policy: [From.Offmap.GetPolicy]."
				log = "-------------------------------------"
				####

				offmap_aztecs = {
					clr_offmap_tmp_flag = colony_is_on_map
					clr_offmap_tmp_flag = colony_is_not_on_map
					clr_offmap_tmp_flag = launching_invasion_of_the_west
					clr_offmap_tmp_flag = tributary_invasion_fired
					clr_offmap_tmp_flag = major_invasion_fired
		    		clr_offmap_tmp_flag = sent_major_invasion_cleanup
		    		clr_offmap_tmp_flag = pretender_chinese_empire_exists
		    	}
			}
		}
    }
}

##Visible event for player: "Become tributary of China, or prepare to be conquered"
character_event = {
    id = SSIOM.10130
    is_triggered_only = yes
    picture = GFX_evt_battle_mesoamerican
    desc = EVTDESC_SSIOM_10130_A
    has_dlc = "Sunset Invasion"

    immediate = {
    	set_character_flag = asked_to_become_tributary
    }

    option = {	
		name = {
        	text = EVTOPTA_SSIOM_10130 #We would be humbled to serve the Emperor...
        	trigger = {
				NOT = { has_character_modifier = aztec_raid_active }
        	}
        }
		
		name = {
        	text = EVTOPTA_SSIOM_10130_B # We raid Aztecs
        	trigger = {
				has_character_modifier = aztec_raid_active
        	}
        }
    	
		prestige = -100
		add_respect_minor_effect = yes

		if = {
			limit = { is_tributary = yes }
			custom_tooltip = {
				text = "REMOVE_PREVIOUS_SUZERAIN"
				hidden_tooltip = {
					any_suzerain = {
						ROOT = {
							remove_tributary = PREV
						}
					}
				}
			}
		}

		if = { # Remove Raid China if active
			limit = {
				has_character_modifier = aztec_raid_active
			}
			remove_character_modifier = aztec_raid_active
			hidden_effect = {
				add_character_modifier = {
					name = aztec_raid_respect_cd
					hidden = yes
					years = 5
				}
			}
		}

		FROM = {
			prestige = 200
			make_tributary = { who = ROOT tributary_type = aztec_offmap_trib }
		}

		#Send news of you becoming tributary, to interested player parties...
		any_player = {
			limit = {
				has_offmap_news_enabled = offmap_aztecs
				is_within_diplo_range = ROOT
				NOT = { character = ROOT }
			}
    		narrative_event = { id = SSIOM.10105 } #News: "Aztec has gained <target> as their tributary"
		}

		clr_character_flag = asked_to_become_tributary

		ai_chance = {
			factor = 20
			modifier = {
				factor = 1.5
				trait = craven
			}
			modifier = {
				factor = 1.1
				offmap_aztecs = {
					has_policy = aztec_invaders
				}
			}
		}
    }
    option = {
    	name = EVTOPTB_SSIOM_10130 #Never!
    	detract_respect_super_huge_effect = yes
    	custom_tooltip = {
    		text = EVTOPTB_SSIOM_10130_TT
    	}
    	FROM = {
    		character_event = { id = SSIOM.10101 } #WP declares tributary war on you...
    	}

    	clr_character_flag = asked_to_become_tributary

    	ai_chance = {
			factor = 10
			modifier = {
				factor = 1.1
				trait = brave
			}
			modifier = {
				factor = 1.1
				trait = ambitious
			}
			modifier = {
				factor = 1.1
				trait = greedy
			}
			modifier = { #The bigger the realm, the more likely they are to oppose the offer...
				factor = 1.5
				num_of_count_titles_in_realm = 10
			}
			modifier = {
				factor = 1.5
				num_of_count_titles_in_realm = 15
			}
			modifier = {
				factor = 1.5
				num_of_count_titles_in_realm = 20
			}
		}
    }
}

##### Tributary Invasion [where the CB is set and troops are spawned] #####
character_event = {
    id = SSIOM.10101
    desc = EVTDESC_SSIOM_10101

    has_dlc = "Sunset Invasion"

    picture = GFX_evt_battle_mesoamerican
    border = GFX_event_normal_frame_war
    is_triggered_only = yes

	hide_window = yes
    
    immediate = {
    	set_offmap_tmp_flag = tributary_invasion_fired

    	### Depending on type of invasion, where the troops spawn will be different... Example below:
    	if = { #If the WP currently holds land on map, spawn Aztec Troops from their capital
			limit = { has_offmap_tmp_flag = colony_is_on_map }
			
			random_realm_province = {
				limit = { is_capital = yes }
				save_event_target_as = aztec_invasion_spawn_point_province
			}

		}
		if = { #If NOT on map, find random good place to spawn the Chinese Troops (in this example, Anxi or Dunhuang)
			limit = { has_offmap_tmp_flag = colony_is_not_on_map }

			random_list = {
				10 = { #Lixpoyatlan
					160 = { save_event_target_as = aztec_invasion_spawn_point_province }
				}
				10 = { #Some frenkisk place.
					149 = { save_event_target_as = aztec_invasion_spawn_point_province }
				}
			}
		}

		war = {
			casus_belli = tributary_offmap_aztecs_cb
			target = event_target:aztec_invasion_target
		}

		event_target:aztec_invasion_spawn_point_province = {
			save_event_target_as = spawn_province
			set_variable = {
				which = aztec_troop_quantity
				value = 80
			}
			set_variable = {
				which = aztec_troop_quality
				value = 6
			}
			aztec_war_modify_variables_by_status_effect = yes
			aztec_war_modify_variables_by_century_effect = yes
			aztec_war_spawn_troops_effect = yes
		}
		
		### Logging....
		if = {
			limit = {
				event_target:aztec_invasion_target = {
					NOT = { num_of_count_titles_in_realm = 20 }
				}
			}
			log = "-------------------------------------"
			log = "Aztec Logging:"
			log = "Aztecs declared MINOR tributary war on [aztec_invasion_target.GetBestName]"
			log = "Current status: [FromFrom.Offmap.GetStatus]. Current policy: [FromFrom.Offmap.GetPolicy]."
			log = "-------------------------------------"
		}
		else = {
			log = "-------------------------------------"
			log = "Aztec Logging:"
			log = "Aztecs declared MEDIUM tributary war on [aztec_invasion_target.GetBestName]"
			log = "Current status: [FromFrom.Offmap.GetStatus]. Current policy: [FromFrom.Offmap.GetPolicy]."
			log = "-------------------------------------"
		}


		#offmap_aztecs = {
		#	if = {
		#		limit = {
		#			has_policy = china_open
		#		}
		#		change_variable = {
		#			which = global_china_amount_of_tributary_wars_during_open
		#			value = 1
		#		}
		#	}
		#	if = {
		#		limit = {
		#			has_policy = aztec_invaders
		#		}
		#		change_variable = {
		#			which = global_china_amount_of_tributary_wars_during_expansionist
		#			value = 1
		#		}
		#	}
		#}
		###

    	#Send news of invasion to interested player parties...
		any_player = {
			limit = {
				has_offmap_news_enabled = offmap_aztecs
				is_within_diplo_range = ROOT
			}
    		narrative_event = { id = SSIOM.10102 } #News: "Aztec has launched an attack on <target> to make them their tributary"
		}
    }
}

narrative_event = { #NEWS: visible event for player (someone PEACEFULLY became a tributary to China, from accepting the demand) 
    id = SSIOM.10105
	has_dlc = "Sunset Invasion"
    title = NEWS_FROM_TENOCHTITLAN
	picture = GFX_evt_battle_mesoamerican
	portrait = offmap_aztecs
	window = EventWindowOffmap
	background = GFX_event_window_news_from_china
    is_triggered_only = yes
    
	desc = {
		text = EVTDESC_SSIOM_10105_A
		trigger = {
			event_target:aztec_invasion_target = { #if a small place
				NOT = { num_of_count_titles_in_realm = 20 }
			}
		}
	}
	desc = {
		text = EVTDESC_SSIOM_10105_B
		trigger = {
			event_target:aztec_invasion_target = { #if a bigger realm
				num_of_count_titles_in_realm = 20
			}
		}
	}

    
    option = {      
        name = EVTOPTA_SSIOM_10105
        show_portrait = event_target:aztec_invasion_target
        custom_tooltip = { text = EVTOPTA_SSIOM_10105_TT }
    }
}

narrative_event = { # NEWS: visible event for player (tributary invasion)
    id = SSIOM.10102
	has_dlc = "Sunset Invasion"
    title = NEWS_FROM_TENOCHTITLAN
	picture = GFX_evt_battle_mesoamerican
	portrait = offmap_aztecs
	window = EventWindowOffmap
	background = GFX_event_window_news_from_china

	desc = {
		text = EVTDESC_SSIOM_10102_A
		trigger = {
			event_target:aztec_invasion_target = { character = ROOT }
		}
	}
	desc = {
		text = EVTDESC_SSIOM_10102_B
		trigger = {
			NOT = { event_target:aztec_invasion_target = { character = ROOT } }
		}
	}

	has_dlc = "Sunset Invasion"

    is_triggered_only = yes

    option = {
        name = {
        	text = EVTOPTA_SSIOM_10102_A_brave
        	trigger = {
				trait = brave
        	}
        }
        name = {
        	text = EVTOPTA_SSIOM_10102_A_craven
        	trigger = {
				trait = craven
        	}
        }
        name = {
        	text = EVTOPTA_SSIOM_10102_A_pious
        	trigger = {
				is_pious_trigger = yes
        	}
        }
        name = {
        	text = EVTOPTA_SSIOM_10102_A_neutral
        	trigger = {
				NOT = { trait = craven }
				NOT = { trait = brave }
				NOT = { is_pious_trigger = yes }
        	}
        }
        trigger = {
         	event_target:aztec_invasion_target = { character = ROOT }
        }
    }

    option = {
        name = {
        	text = EVTOPTA_SSIOM_10102_B_same_religion #May [HighGod] protect them
        	trigger = {	event_target:aztec_invasion_target = { religion_group = ROOT } }
        }
        name = {
        	text = EVTOPTA_SSIOM_10102_B_other_religion #May their gods protect them #This strikes me as weird. Surely you only believe your god can protect people since, you know, that's the only one you believe in?
        	trigger = {	NOT = { event_target:aztec_invasion_target = { religion_group = ROOT } } }
        }

        event_target:aztec_invasion_target = { show_portrait = yes }
        
        trigger = {
         	NOT = { event_target:aztec_invasion_target = { character = ROOT } }
        }
    }
}


##### Major Invasion [where the CB is set and troops are spawned] ##### WIP
character_event = {
    id = SSIOM.10103

    has_dlc = "Sunset Invasion"

    is_triggered_only = yes

	hide_window = yes
    
	trigger = {
		has_global_flag = aztec_arrival #Don't fire this until after inital invasion.
	}

    immediate = {
    	if = { limit = { NOT = { has_offmap_tmp_flag = attacked_small_neighbor } } #only mark as "major" if it was actually that
    		set_offmap_tmp_flag = major_invasion_fired #used for cooldown (cleared from other yearly pulse clean-up events)
    	}

    	if = { #If the WP currently holds land on map, spawn Chinese Troops from their capital
			limit = { has_offmap_tmp_flag = colony_is_on_map }
			
			random_realm_province = {
				limit = { is_capital = yes }
				save_event_target_as = aztec_invasion_spawn_point_province
			}
		}
		if = { #If NOT on map, find random good place to spawn the Chinese Troops
			limit = { has_offmap_tmp_flag = colony_is_not_on_map }

			random_list = {
				10 = { #Lixpoyatlan
					160 = { save_event_target_as = aztec_invasion_spawn_point_province }
				}
				10 = { #Some frenkisk place
					149 = { save_event_target_as = aztec_invasion_spawn_point_province }
				}
				10 = { #Holland
					80 = { save_event_target_as = aztec_invasion_spawn_point_province } 
				}
				10 = { #Nordjuetland
					267 = { save_event_target_as = aztec_invasion_spawn_point_province } 
				}
				10 = { #Another frenkisk backwater
					212 = { save_event_target_as = aztec_invasion_spawn_point_province } 
				}
				10 = { #Definitely Not Spain
					173 = { save_event_target_as = aztec_invasion_spawn_point_province } 
				}
			}
		}

		#Declare war on target...
		if = {
			limit = { has_offmap_tmp_flag = should_claim_all_titles_war }
			if = {
				limit = {
					can_use_cb = {
						casus_belli = claim_all
						target = event_target:aztec_invasion_target
						only_check_triggers = yes
					}
				}
				war = {
					casus_belli = claim_all
					target = event_target:aztec_invasion_target
				}
			}
			else = {
				any_claim = {
					limit = {
						holder_scope = {
							OR = {
								character = event_target:aztec_invasion_target
								top_liege = {
									character = event_target:aztec_invasion_target
								}
							}
						}
					}
					ROOT = {
						war = {
							casus_belli = claim
							target = event_target:aztec_invasion_target
							thirdparty_title = PREV
						}						
					}
				}
			}
		}
		if = {
			limit = { has_offmap_tmp_flag = start_submission_war }
			war = {
				casus_belli = offmap_submission
				target = event_target:aztec_invasion_target
			}
		}
		event_target:aztec_invasion_spawn_point_province = {
			save_event_target_as = spawn_province
			set_variable = {
				which = aztec_troop_quantity
				value = 80
			}
			set_variable = {
				which = aztec_troop_quality
				value = 6
			}
			aztec_war_modify_variables_by_status_effect = yes
			aztec_war_modify_variables_by_century_effect = yes
			aztec_war_spawn_troops_effect = yes
		}


		### Logging
		log = "-------------------------------------"
		log = "Aztec Logging:"
		log = "Aztecs declared submission/claim war on [aztec_invasion_target.GetBestName]"
		log = "Current status: [From.Offmap.GetStatus]. Current policy: [From.Offmap.GetPolicy]."
		log = "-------------------------------------"

		### Logging....
		if = {
			limit = { has_offmap_tmp_flag = start_submission_war }
			if = {
				limit = {
					event_target:aztec_invasion_target = {
						NOT = { num_of_count_titles_in_realm = 20 }
					}
				}
				log = "-------------------------------------"
				log = "Aztec War Logging:"
				log = "Aztec declared MINOR submission war on [aztec_invasion_target.GetBestName]"
				log = "Current status: [FromFrom.Offmap.GetStatus]. Current policy: [FromFrom.Offmap.GetPolicy]."
				log = "-------------------------------------"
			}
			else = {
				log = "-------------------------------------"
				log = "Aztec War Logging:"
				log = "Aztec declared MAJOR submission war on [aztec_invasion_target.GetBestName]"
				log = "Current status: [FromFrom.Offmap.GetStatus]. Current policy: [FromFrom.Offmap.GetPolicy]."
				log = "-------------------------------------"
			}
		}

		if = {
			limit = { has_offmap_tmp_flag = should_claim_all_titles_war }
			if = {
				limit = {
					event_target:aztec_invasion_target = {
						NOT = { num_of_count_titles_in_realm = 20 }
					}
				}
				log = "-------------------------------------"
				log = "Aztec War Logging:"
				log = "Aztec declared MINOR claim war on [aztec_invasion_target.GetBestName]"
				log = "Current status: [FromFrom.Offmap.GetStatus]. Current policy: [FromFrom.Offmap.GetPolicy]."
				log = "-------------------------------------"
			}
			else = {
				log = "-------------------------------------"
				log = "Aztec War Logging:"
				log = "Aztec declared MEDIUM claim war on [aztec_invasion_target.GetBestName]"
				log = "Current status: [FromFrom.Offmap.GetStatus]. Current policy: [FromFrom.Offmap.GetPolicy]."
				log = "-------------------------------------"
			}
		}

		#offmap_aztecs = {
		#	if = {
		#		limit = {
		#			has_policy = china_open
		#		}
		#		change_variable = {
		#			which = global_china_amount_of_submission_during_open
		#			value = 1
		#		}
		#	}
		#	if = {
		#		limit = {
		#			has_policy = aztec_invaders
		#		}
		#		change_variable = {
		#			which = global_china_amount_of_submission_during_expansionist
		#			value = 1
		#		}
		#	}
		#}
		
		###
		clr_offmap_tmp_flag = start_submission_war
		clr_offmap_tmp_flag = should_claim_all_titles_war

    	#Send news of invasion to interested player parties...
    	any_player = {
			limit = {
				has_offmap_news_enabled = offmap_aztecs
				is_within_diplo_range = ROOT
			}
    		narrative_event = { id = SSIOM.10104 days = 1 } #News: "Aztec has launched a major attack on <target>"
		}
    }
}

narrative_event = { # NEWS: Major invasion declared on <target>! (Visible event for players + player target, fired from SSIOM.10103)
    id = SSIOM.10104
    title = NEWS_FROM_TENOCHTITLAN
	picture = GFX_evt_battle_mesoamerican
	portrait = offmap_aztecs
	window = EventWindowOffmap
	background = GFX_event_window_news_from_china

	has_dlc = "Sunset Invasion"

	desc = {
		text = EVTDESC_SSIOM_10104_A
		trigger = {
			event_target:aztec_invasion_target = { character = ROOT }
		}
	}
	desc = {
		text = EVTDESC_SSIOM_10104_B
		trigger = {
			NOT = { event_target:aztec_invasion_target = { character = ROOT } }
		}
	}

    is_triggered_only = yes

    option = {
        name = {
        	text = EVTOPTA_SSIOM_10102_A_brave
        	trigger = {
				trait = brave
        	}
        }
        name = {
        	text = EVTOPTA_SSIOM_10102_A_craven
        	trigger = {
				trait = craven
        	}
        }
        name = {
        	text = EVTOPTA_SSIOM_10102_A_pious
        	trigger = {
				is_pious_trigger = yes
        	}
        }
        name = {
        	text = EVTOPTA_SSIOM_10102_A_neutral
        	trigger = {
				NOT = { trait = craven }
				NOT = { trait = brave }
				NOT = { is_pious_trigger = yes }
        	}
        }
        trigger = {
         	event_target:aztec_invasion_target = { character = ROOT }
        }
    }

    option = {
        name = {
        	text = EVTOPTA_SSIOM_10104_B_brave
        	trigger = {
				trait = brave
        	}
        }
        name = {
        	text = EVTOPTA_SSIOM_10104_B_pious
        	trigger = {
				is_pious_trigger = yes
        	}
        }
        name = {
        	text = EVTOPTA_SSIOM_10102_A_neutral
        	trigger = {
				NOT = { trait = craven }
				NOT = { is_pious_trigger = yes }
        	}
        }

        event_target:aztec_invasion_target = { show_portrait = yes }

        trigger = {
         	NOT = { event_target:aztec_invasion_target = { character = ROOT } }
        }
    }
}


#Cleanup event REGULAR [sent from yearly pulse]
character_event = {
    id = SSIOM.10200

    has_dlc = "Sunset Invasion"

    is_triggered_only = yes
    
    hide_window = yes

    trigger = {
    	FROM = { is_offmap_tag = offmap_aztecs }
    	OR = {
	    	offmap_aztecs = {
	    		had_offmap_tmp_flag = {
	    			flag = tributary_invasion_fired
	    			years = 5
	    		}
	    	}
	    	offmap_aztecs = {
	    		had_offmap_tmp_flag = {
	    			flag = launching_invasion_of_the_east
	    			years = 5
	    		}
	    	}
	    	offmap_aztecs = { #To make sure smaller wars can be waged more often...
	    		had_offmap_tmp_flag = {
	    			flag = attacked_small_neighbor
	    			years = 3
	    		}
	    	}	    	
    	}
    }

    immediate = {
    	offmap_aztecs = {
			clr_offmap_tmp_flag = colony_is_on_map
			clr_offmap_tmp_flag = colony_is_not_on_map
			clr_offmap_tmp_flag = launching_invasion_of_the_east
			clr_offmap_tmp_flag = tributary_invasion_fired
			clr_offmap_tmp_flag = attacked_small_neighbor
    	}
    }
}

#Cleanup event for MAJOR invasion [sent from yearly pulse] 
character_event = {
    id = SSIOM.10201

    has_dlc = "Sunset Invasion"

    is_triggered_only = yes
    
    hide_window = yes

    trigger = {
    	FROM = { is_offmap_tag = offmap_aztecs }
    	offmap_aztecs = {
    		OR = {
	    		had_offmap_tmp_flag = {
					flag = major_invasion_fired
					years = 20
				}
				had_offmap_tmp_flag = {
					flag = sent_major_invasion_cleanup
					years = 5
				}
			}
    	}
    }

    immediate = {
    	offmap_aztecs = {
    		clr_offmap_tmp_flag = major_invasion_fired
    		clr_offmap_tmp_flag = sent_major_invasion_cleanup
    	}
    }
}